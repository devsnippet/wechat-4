<!DOCTYPE html>
<html>
  <head>
    <title>DeNA 游戏</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimal-ui">
    <meta name="msapplication-tap-highlight" content="no" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="http://static.mobage.cn/html/common/js/jquery-1.10.2.min.js"></script>
    <!--<script src="http://static.mobage.cn/html/promotion/wechat/news_push/js/wechat_share.js"></script>
    <!-- <script src="//static.mobage.cn/html/common/js/Sortable.js"></script>
    <!--<script src="http://apps.bdimg.com/libs/bootstrap/2.3.2/js/bootstrap.js"></script>-->
    <style type="text/css">
    /*!
 * # Semantic UI - Reset
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Copyright 2015 Contributors
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */*,:after,:before{box-sizing:inherit}html{box-sizing:border-box}input[type=text],input[type=email],input[type=search],input[type=password]{-webkit-appearance:none;-moz-appearance:none}/*! normalize.css v3.0.1 | MIT License | git.io/normalize *//*! normalize.css v3.0.1 | MIT License | git.io/normalize */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background:0 0}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}
input[type=password],input[type=text]{font-family:Arial,Helvetica,sans-serif;margin:0;outline:0;-webkit-appearance:none;tap-highlight-color:rgba(255,255,255,0);line-height:1.2142em;padding:.67861429em 1em;font-size:1em;background:#fff;border:1px solid rgba(34,36,38,.15);color:rgba(0,0,0,.87);border-radius:.28571429rem;box-shadow:0 0 0 0 transparent inset;-webkit-transition:color .1s ease,border-color .1s ease;transition:color .1s ease,border-color .1s ease}input[type=submit]{display:inline-block;min-height:1em;outline:0;border:0;vertical-align:baseline;color:rgba(0,0,0,.6);margin:0 .25em 0 0;padding:.78571429em 1.5em .78571429em;text-transform:none;text-shadow:none;font-weight:700;line-height:1em;font-style:normal;text-align:center;text-decoration:none;border-radius:.28571429rem;box-shadow:0 0 0 1px transparent inset,0 0 0 0 rgba(34,36,38,.15) inset;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-transition:opacity .1s ease,background-color .1s ease,color .1s ease,box-shadow .1s ease,background .1s ease;transition:opacity .1s ease,background-color .1s ease,color .1s ease,box-shadow .1s ease,background .1s ease;will-change:'';-webkit-tap-highlight-color:transparent}input:focus{border-color:rgba(34,36,38,.35);background:#fff;color:rgba(0,0,0,.8);box-shadow:none}body{background-color:#d2d2d2;font-family:Tahoma,Helvetica,SimSun,sans-serif}.header{background:-webkit-gradient(linear,0 0,0 100%,from(#a4c550),to(#84b619));font-size:18px;-webkit-box-shadow:0 1px 5px #AAA,inset 0 0 1px #bfdb8e;color:#fff;text-align:center;line-height:45px;height:45px;vertical-align:middle;border-bottom:1px solid #6b9505;border-top:1px solid #6b9505;font-weight:700}.main{width:350px;margin:0 auto}.input-container{margin:10px 0}.input-control{width:310px}input[type="submit"]{text-align:center;width:150px;background-color:#84b619;color:#fff;text-shadow:none}/*input[type="submit"]:active{background-color:#a4c550}*/.form-container{text-align:center;margin-top:30%;border-radius:8px;background:#fff;border:1px solid #fff;color:#000;box-shadow:0 0 15px #222;background:-moz-linear-gradient(top,#fff,#efefef 8%);background:-webkit-gradient(linear,0 0,0 100%,from(#f6f6f6),to(#f4f4f4));padding:10px}
    </style>
  </head>
<body>
<?php
//公众号信息
$app_id = isset($APPID) && !empty($APPID) ? $APPID : 'wx21a660b4216da13a';//优先从URL中获取公众号的APPID，否则默认使用DeNAGame的服务号，利用指定公众号发送确认消息
$app_secrect = isset($APPSECRET) && !empty($APPSECRET) ? $APPSECRET : 'bb482080b33dc6df0a82f7905730942a';
 $redirect_uri = urlencode('http://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']);
 if(!isset($_GET['code']) || empty($_GET['code'])){
    header("Location: https://open.weixin.qq.com/connect/oauth2/authorize?appid=$app_id&redirect_uri=$redirect_uri&response_type=code&scope=snsapi_base&state=STATE&connect_redirect=1#wechat_redirect");

}else{
    $code = $_GET['code'];
    $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=$app_id&secret=$app_secrect&code=$code&grant_type=authorization_code";
  
    $result = httpGet($url);
    
    $result_arr = json_decode($result,true);//获取的用户数据数组
    if (isset($result_arr['errcode'])) {
        //code不正确，因为URL中直接带了code 重新跳转回去进行oauth
        header("Location: http://wechat-admin.mobage.cn/news_push/bind");
    }
    // print_r($result_arr);
}  

 function httpGet($url) {
    $oCurl = curl_init();
    if(stripos($url,"https://")!==FALSE){
        curl_setopt($oCurl, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($oCurl, CURLOPT_SSL_VERIFYHOST, FALSE);
        curl_setopt($oCurl, CURLOPT_SSLVERSION, 1); //CURL_SSLVERSION_TLSv1
    }
    curl_setopt($oCurl, CURLOPT_URL, $url);
    curl_setopt($oCurl, CURLOPT_RETURNTRANSFER, 1 );
    $sContent = curl_exec($oCurl);
    $aStatus = curl_getinfo($oCurl);
    curl_close($oCurl);
    if(intval($aStatus["http_code"])==200){
        return $sContent;
    }else{
        return false;
    }
  }
 
?>
<script type="text/javascript">
    document.body.addEventListener('touchmove', function (event) {
        event.preventDefault();
    }, false);
    
    var unionid="<?=$result_arr['unionid']?>";
    var access_token="<?=$result_arr['access_token']?>";
    var refresh_token="<?=$result_arr['refresh_token']?>";
    var scope="<?=$result_arr['scope']?>";
    var expires="<?=$result_arr['expires_in']?>";
</script>
<div class="container">
        <div class="header">
            <span>梦宝谷通行证绑定</span>
        </div>
        <div class="main">
            <div class="form-container">
                <form onsubmit="return submitForm();">
                    <div class="input-container">
                        <!-- <input type="hidden" name="openid" value="xx" id="openid"></input> -->
                        <input type="text" name="user_id" placeholder="输入梦宝谷通行证" class="input-control" id="user_id"></input>
                    </div>
                    <div class="input-container">
                        <input type="password" name="pass_word" placeholder="输入您的密码" class="input-control" id="pass_word"></input>
                    </div>
                    <div class="input-container">
                        <input type="submit" value="提交" id="submit"></input>
                    </div>
                </form>
            <div id="bindinfo"></div>
            <div class="tips" id="tips">
                <p>绑定梦宝谷帐号后, 您可以通过本微信号接收账户相关的提醒。</p>
            </div>
            </div>
            
        </div>
        <div class="footer">
            <!-- copyright at xxxx -->
        </div>

    </div>
    <!-- <div class="container">
        <div class="row">
            <div class="span12">
               
                    <legend>输入账号信息进行</legend>
                    
                    <div class="control-group">
                       

                            账号：<input type="text" name="user_id" id="user_id" placeholder="梦宝谷ID"  class="span2">
                            密码：<input type="password" name="pass_word" id="pass_word" placeholder="密码" value="" class="span6">

                    </div>

                    <div class="control-group" id="aciton">
                        <div class="controls">
                            <input type="hidden" name="act" value="bind_account">
                            <button class="btn btn-primary" id="submit">绑定</button>
                        </div>
                    </div>
            
            </div>
        </div>
    </div> -->
<script>

    var check_num = /^[0-9]*$/;
    $('#submit').click(function(){
        var user_id=$('#user_id').val();
        var pass_word=$('#pass_word').val();
        
        var bind_info = $('#bindinfo');

        var busy=0;
            
        if(user_id==''){
            bind_info.html('<p style="color:red;">梦宝谷ID不能为空</p>');
            return false;
        }
        if(!check_num.test(user_id)){
            bind_info.html('<p style="color:red;">梦宝谷ID由数字组成</p>');
            return false;
        }
        if(pass_word==''){
            bind_info.html('<p style="color:red;">密码不能为空</p>');
            return;
        }
        if(busy==0){
            busy=1;
            $.post('bind', {
                'act': 'bind_account',
                'user_id': user_id,
                'pass_word': pass_word,
                'unionid': unionid,
                'access_token': access_token,
                'refresh_token': refresh_token,
                'scope': scope,
                'expires_in': expires
            }).done(function(data){
                busy=0;
                
                var data_json=$.parseJSON(data);
                var bind_status=data_json.bind_status;
                var bind_msg=data_json.bind_msg;
                if(bind_status==-1){
                    bind_info.html('<p style="color:red;">梦宝谷账号不存在</p>');
                    // alert('账号不存在！');
                    return;
                }
                if(bind_status==0){
                    bind_info.html('<p style="color:red;">绑定出现错误</p>');
                    // alert('绑定出现错误！');
                    return;
                }
                if(bind_status==1){
                    
                    //绑定成功,推送微信模板消息
                    $.post('index/bind_account', {
                    'user_id': user_id
                   
                    }).done(function(data){
                        bind_info.html('<p style="color:green;">绑定成功，详细信息已通过微信消息发送</p>');
                        // alert('绑定成功，详细信息已通过微信消息发送！');
                        return;
                    }).fail(function(data){
                        bind_info.html('<p style="color:green;">账号绑定成功</p>');
                        // alert('账号绑定成功！');
                        console.log($.parseJSON(data));
                        return;
                    });
                        
                   
                    return;
                }
                if(bind_status==2){
                    bind_info.html('<p style="color:red;">很抱歉，您输入的账号或密码有误</p>');
                    // alert('账号或密码有误！');
                    return;
                }
                
                if(bind_status==3 || bind_status==4 || bind_status==5 || bind_status==6){//unionid（为空）或者user_id非法
                    bind_info.html('<p style="color:red;">很抱歉, 绑定失败</p>');
                    // alert('绑定失败！');
                    return;
                }

                

            }).fail(function(data){
                busy=0;
                bind_info.html('<p style="color:red;">请求发送失败, 网络错误</p>');
                console.log($.parseJSON(data));
                return;
            });

        }else{
            return;
        }
        return false;
    });

</script>
</body>
</html>